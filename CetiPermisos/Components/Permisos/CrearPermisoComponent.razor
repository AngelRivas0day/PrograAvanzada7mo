@using Entities
@using Business

@inject NavigationManager NavManager

<div class="form-container" style="max-width: 500px; margin: 0 auto; display: block;">
    <EditForm Model="oPermiso">
        <div class="form-group">
            <label>Tipo de permiso</label>
            <InputSelect @oninput="OnChangeType" @bind-Value="oPermiso.PermisoTipo" class="form-control">
                <option>Selecciona una opcion</option>
                <option value="2 horas">2 horas</option>
                <option value="Economico">Economico</option>
                <option value="Cumpleanios">Cumplea&ntilde;os</option>
            </InputSelect>
        </div>
        <div class="form-group">
            <label>Fecha de elaboraci&oacute;n</label>
            <InputDate type="date" @bind-Value="oPermiso.PermisoFechaElaboracion" class="form-control" disabled />
        </div>
        @if (types.Contains(oPermiso.PermisoTipo, StringComparer.OrdinalIgnoreCase))
        {
            <div class="form-group">
                <label>Fecha de aplicaci&oacute;n</label>
                <InputDate type="date" @oninput="OnChangeApplicationDate" @bind-Value="oPermiso.PermisoFechaAplicacion" class="form-control" />
            </div>
            @if (oPermiso.PermisoTipo == "2 horas")
            {
                <div class="form-group">
                    <label>Hora de aplicaci&oacute;n</label>
                    <select @onchange="OnChangeTime" value="@applicationTime" class="form-control">
                       @foreach(var hour in hours)
                        {
                            <option value="@hour">@hour horas</option>
                        }
                    </select>
                </div>
            }
            <div class="form-group">
                <label>Fecha de finalizaci&oacute;n</label>
                <InputDate type="date" @bind-Value="oPermiso.PermisoFechaFinalizacion" class="form-control" disabled />
            </div>
            @if (oPermiso.PermisoTipo == "2 horas")
            {
                <div class="form-group">
                    <label>Hora de finalizaci&oacute;n</label>
                    <input class="form-control" value="@finalizationTime" disabled />
                </div>
            }
        }
        <div class="d-block">
            @if(message is not null)
             {
                <SurveyPrompt Title="@message" />
             }
        </div>
        <input class="btn btn-primary" type="submit" value="Solicitar permiso" @onclick="CreatePermiso" />
    </EditForm>
    @*@message
    @applicationTime
    @finalizationTime*@
</div>


@code {

    PermisoEntity oPermiso = new PermisoEntity();
    TrabajadorEntity trabajador = new TrabajadorEntity();
    public string message = null;
    public string[] types = { "2 horas", "Cumpleanios", "Economico" };
    public string[] hours = { "07:00", "13:00" };
    private static int currentYear = DateTime.Now.Year;
    public DateTime[] diasFestivos = { new DateTime(currentYear, 1,1) };
    public string applicationTime = "";
    public string finalizationTime = "";
    protected override void OnInitialized()
    {
        trabajador = B_Trabajador.TrabajadorPorNomina("106");
        oPermiso.PermisoFechaElaboracion = DateTime.Now;
        oPermiso.PermisoFechaAplicacion = DateTime.Now;
        oPermiso.TrabajadorId = trabajador.TrabajadorNomina;
        applicationTime = hours[0];
        finalizationTime = "09:00";
    }

    private void CreatePermiso()
    {
        // si la fecha de aplicacion es antes de hoy, salimos de la funcion
        if (DateTime.Now > oPermiso.PermisoFechaAplicacion) { return; }
        // validar si puede pedir permisos en funcion de los permisos pedidos anteriormente 
        if (!ValidarNumeroDePermisos()) { return; }
        // validar que los datos el permiso actual sean correctos
        if (!ValidarPorTipoDePermiso()) { return; }
        // Agregar horas cuando sea permiso de dos horas
        if (oPermiso.PermisoTipo == "2 horas")
        {
            // Obtenemos los primeros dos numeros del string que representa la hora e.g 17:00 => 17
            var startHours = applicationTime.Split(':')[0];
            var endHours = finalizationTime.Split(':')[0];
            // Agregamos la cantidad de horas correspondientes a las fechas de aplicacion y fechas de cierre con la funcion .AddHours
            oPermiso.PermisoFechaFinalizacion = Convert.ToDateTime(oPermiso.PermisoFechaFinalizacion).AddHours(Double.Parse(endHours));
            oPermiso.PermisoFechaAplicacion = Convert.ToDateTime(oPermiso.PermisoFechaAplicacion).AddHours(Double.Parse(startHours));
        }
        oPermiso.PermisoEstado = "PENDIENTE";
        B_Permiso.CrearPermiso(oPermiso);
        NavManager.NavigateTo("permisos/lista");
    }

    private bool ValidarPorTipoDePermiso()
    {
        // validaciones y procesos para permiso de cumpleaños
        if (oPermiso.PermisoTipo == "Cumpleanios")
        {
            // validar que la fecha de aplicacion sea max 6 meses despues de la fecha de cumpleaños
            int bdayMonth = trabajador.TrabajadorFechaNacimiento.Month;

            DateTime applicationDate = oPermiso.PermisoFechaAplicacion;
            DateTime currentBirthday = new DateTime(currentYear, bdayMonth, trabajador.TrabajadorFechaNacimiento.Day);

            // si la fecha de aplicacion es antes que el mes de cumpleaños salimos de la función
            if (applicationDate < currentBirthday) { return false; }
            // si la fecha de aplicacion sigue siendo mas grande que el cumpleaños + 6 meses, salimos de la función
            if (currentBirthday.AddMonths(6) < applicationDate) { return false; }
        }
        if (oPermiso.PermisoTipo == "Economico")
        {
            DateTime applicationDate = oPermiso.PermisoFechaAplicacion;
            DateTime elaborationDate = oPermiso.PermisoFechaElaboracion;
            // validar que tenga por lo menos dos dias de diferencia la fecha de aplicacion y la de elaboracion
            if (elaborationDate.AddDays(2) > applicationDate) { return false; }
        }
        return true;
    }

    private bool ValidarNumeroDePermisos()
    {
        List<PermisoEntity> permisos = B_Permiso.PermisosPorTrabajador(trabajador.TrabajadorNomina);
        // permisos en lapso de dos dias
        if(permisos.ToArray().Length != 0)
        {
            if (permisos[0].PermisoFechaElaboracion.AddDays(2) > DateTime.Now) { return false; }
        }
        // permisos economicos
        if(oPermiso.PermisoTipo == "Economico")
        {
            List<PermisoEntity> permisosEconomicos = permisos
                                                        .Where(p => p.PermisoTipo == "Economico")
                                                        .Where(p => p.PermisoFechaElaboracion.Year == currentYear)
                                                        .ToList();
            List<PermisoEntity> permisosEconomicosDelMes = permisosEconomicos
                                                            .Where(p => p.PermisoFechaElaboracion.Month == DateTime.Now.Month)
                                                            .ToList();
            // si este año hay 9 o más permisos economicos, no se pueden pedir más
            if (permisosEconomicos.ToArray().Length >= 9) { return false; }
            // si hay otro permiso economico en el mismo mes, no se pueden pedir más
            if(permisosEconomicosDelMes.ToArray().Length != 0) { return false; }
        }

        // permisos de dos horas
        if(oPermiso.PermisoTipo == "2 horas")
        {
            // permisos de dos horas dentro de la quincena actual
            int currentMonth = DateTime.Now.Month;
            int currentMonthMaxDays = (new DateTime(currentYear, currentMonth, 1).AddMonths(1).AddDays(-1)).Day;
            bool firstHalf = oPermiso.PermisoFechaElaboracion.Day <= 15 ? true : false;
            List<PermisoEntity> permisosDeDosHoras = permisos
                                                        .Where(p => p.PermisoTipo == "2 horas")
                                                        .Where(p =>
                                                            p.PermisoFechaElaboracion > new DateTime(currentYear, currentMonth, firstHalf ? 1 : 15)
                                                            && p.PermisoFechaElaboracion < new DateTime(currentYear, currentMonth, firstHalf ? 15 : currentMonthMaxDays)
                                                        )
                                                        .ToList();
            // si hay mas de dos permisos en esta quincena, no se otorga otro
            if(permisosDeDosHoras.ToArray().Length >= 2) { return false; }
        }
        return true;
    }

    private bool ValidateDatesDiff()
    {
        var firstDate = oPermiso.PermisoFechaElaboracion;
        var secondDate = oPermiso.PermisoFechaAplicacion;
        var datesDiff = Convert.ToInt32((secondDate - firstDate).TotalDays.ToString());
        return datesDiff > 2 ? false : true;
    }

    private void OnChangeType(ChangeEventArgs e)
    {
        if(e.Value.ToString() == "Economico")
            oPermiso.PermisoFechaFinalizacion = oPermiso.PermisoFechaAplicacion.AddDays(2);
        if (e.Value.ToString() == "Cumpleanios")
            oPermiso.PermisoFechaFinalizacion = oPermiso.PermisoFechaAplicacion.AddDays(1);
        if (e.Value.ToString() == "2 horas")
            oPermiso.PermisoFechaFinalizacion = oPermiso.PermisoFechaAplicacion.AddHours(2);
    }

    private void OnChangeApplicationDate(ChangeEventArgs e)
    {
        if (oPermiso.PermisoTipo == "Economico")
            oPermiso.PermisoFechaFinalizacion = Convert.ToDateTime(e.Value.ToString()).AddDays(2);
        if (oPermiso.PermisoTipo == "Cumpleanios")
            oPermiso.PermisoFechaFinalizacion = Convert.ToDateTime(e.Value.ToString()).AddDays(1);
        if (oPermiso.PermisoTipo == "2 horas")
            oPermiso.PermisoFechaFinalizacion = Convert.ToDateTime(e.Value.ToString()).AddHours(2);
    }

    private void OnChangeTime(ChangeEventArgs e)
    {
        var currentIndex = Array.IndexOf(hours, e.Value.ToString());
        if(currentIndex == 0)
            finalizationTime = "09:00";
        else if(currentIndex == 1)
            finalizationTime = "15:00";
    }
}
